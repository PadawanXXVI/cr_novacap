{% extends "base.html" %}
{% block title %}Consulta de Processos – Central de Relacionamento NOVACAP{% endblock %}

{% block content %}
<section class="page-wrapper">
  <div class="page-card fade-in">

    <!-- 🔹 Cabeçalho Institucional -->
    <header>
      <img src="{{ url_for('static', filename='../images/ico-logo-gdf.svg') }}" alt="GDF" height="70" style="margin-bottom: 1rem;">
      <h1><i class="fas fa-search"></i> Consulta de Processos – Central de Relacionamento</h1>
      <p>
        Consulte, filtre, exporte ou visualize processos SEI tramitando pela NOVACAP.
      </p>
    </header>

    <!-- 🔍 FILTROS DE PESQUISA -->
    <form method="GET" action="{{ url_for('processos_bp.consultar_processos') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="form-grid">
        <!-- Número SEI -->
        <div>
          <label for="numero_processo"><i class="fas fa-hashtag"></i> Nº Processo SEI</label>
          <input type="text" name="numero_processo" id="numero_processo"
                 placeholder="00000-00000000/0000-00"
                 value="{{ request.args.get('numero_processo', '') }}">
        </div>

        <!-- Status -->
        <div>
          <label for="status"><i class="fas fa-flag"></i> Status</label>
          <select name="status" id="status">
            <option value="">Todos</option>
            {% for s in todos_status %}
              <option value="{{ s.descricao }}" {% if request.args.get('status') == s.descricao %}selected{% endif %}>{{ s.descricao }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Diretoria -->
        <div>
          <label for="diretoria"><i class="fas fa-building"></i> Diretoria de Destino</label>
          <select name="diretoria" id="diretoria">
            <option value="">Todas</option>
            {% for d in diretorias %}
              <option value="{{ d }}" {% if request.args.get('diretoria') == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Região Administrativa -->
        <div>
          <label for="ra"><i class="fas fa-map-marker-alt"></i> Região Administrativa</label>
          <select name="ra" id="ra">
            <option value="">Todas</option>
            {% for r in todas_ras %}
              <option value="{{ r.descricao_ra }}" {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>{{ r.descricao_ra }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Tipo de Demanda -->
        <div>
          <label for="tipo"><i class="fas fa-tag"></i> Tipo de Demanda</label>
          <select name="tipo" id="tipo">
            <option value="">Todos</option>
            {% for t in tipos %}
              <option value="{{ t.id_tipo }}" {% if request.args.get('tipo') == t.id_tipo|string %}selected{% endif %}>{{ t.descricao }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Demanda -->
        <div>
          <label for="demanda"><i class="fas fa-list-ul"></i> Demanda</label>
          <select name="demanda" id="demanda">
            <option value="">Todas</option>
            {% for d in demandas %}
              <option value="{{ d.id_demanda }}" {% if request.args.get('demanda') == d.id_demanda|string %}selected{% endif %}>{{ d.descricao }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Data Início -->
        <div>
          <label for="inicio"><i class="fas fa-calendar-plus"></i> Data Início</label>
          <input type="date" id="inicio" name="inicio" value="{{ request.args.get('inicio', '') }}">
        </div>

        <!-- Data Fim -->
        <div>
          <label for="fim"><i class="fas fa-calendar-alt"></i> Data Fim</label>
          <input type="date" id="fim" name="fim" value="{{ request.args.get('fim', '') }}">
        </div>
      </div>

      <!-- 🔘 Botões de ação -->
      <div class="button-toolbar">
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Consultar</button>
        <a href="{{ url_for('processos_bp.consultar_processos') }}" class="btn btn-outline-gray"><i class="fas fa-undo"></i> Limpar</a>
      </div>
    </form>

    <!-- 📊 RESULTADOS -->
    {% if processos %}
    <div class="export-bar" style="display: flex; justify-content: flex-end; align-items: center; gap: 0.6rem; margin-top: 1.5rem; flex-wrap: wrap;">
      <span style="font-weight: 600; color: var(--text-dark);">Exportar resultados:</span>
      <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='csv') }}" class="btn btn-outline-blue"><i class="fas fa-file-csv"></i> CSV</a>
      <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='xlsx') }}" class="btn btn-outline-blue"><i class="fas fa-file-excel"></i> XLSX</a>
      <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='pdf') }}" class="btn btn-outline-blue"><i class="fas fa-file-pdf"></i> PDF</a>
    </div>

    <div class="table-responsive" style="margin-top: 1rem;">
      <table class="table-hover">
        <thead>
          <tr>
            <th>Nº Processo</th>
            <th>RA Origem</th>
            <th>Tipo</th>
            <th>Diretoria</th>
            <th>Status Atual</th>
            <th>Última Movimentação</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for p in processos %}
          <tr>
            <td><strong>{{ p.numero_processo }}</strong></td>
            <td>{{ p.entrada.ra_origem if p.entrada else '---' }}</td>
            <td>{{ p.entrada.tipo.descricao if p.entrada and p.entrada.tipo else '---' }}</td>
            <td>{{ p.diretoria_destino or '---' }}</td>
            <td>
              {% if "Atendido" in p.status_atual %}
                <span class="badge success">{{ p.status_atual }}</span>
              {% elif "Devolvido" in p.status_atual %}
                <span class="badge warning">{{ p.status_atual }}</span>
              {% elif "Improcedente" in p.status_atual %}
                <span class="badge danger">{{ p.status_atual }}</span>
              {% else %}
                <span class="badge neutral">{{ p.status_atual or "---" }}</span>
              {% endif %}
            </td>
            <td>{{ p.ultima_data.strftime('%d/%m/%Y') if p.ultima_data else '---' }}</td>
            <td>
              <a href="{{ url_for('processos_bp.exportar_processo_pdf', id_processo=p.id_processo) }}"
                 class="btn btn-outline-blue" title="Gerar PDF" aria-label="Gerar PDF do processo {{ p.numero_processo }}">
                <i class="fas fa-file-pdf"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% else %}
    <p style="margin-top: 2rem; text-align: center; color: #777;">
      Nenhum processo encontrado com os filtros aplicados.
    </p>
    {% endif %}

    <!-- ⚙ RODAPÉ -->
    <div class="button-toolbar" style="margin-top: 2.5rem;">
      <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn btn-secondary">
        <i class="fas fa-chart-bar"></i> Voltar ao Dashboard
      </a>
      <a href="{{ url_for('main_bp.logout') }}" class="btn btn-danger">
        <i class="fas fa-sign-out-alt"></i> Sair
      </a>
    </div>

  </div>
</section>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}
