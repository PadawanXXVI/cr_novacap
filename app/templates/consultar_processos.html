{% extends "base.html" %}
{% block title %}Consulta de Processos – Central de Relacionamento NOVACAP{% endblock %}

{% block content %}
<section class="page-section fade-in" style="max-width: 1200px; margin: 2rem auto;">

  <!-- 🔹 Cabeçalho Institucional -->
  <header class="page-header">
    <h1><i class="fas fa-search"></i> Consulta de Processos</h1>
    <p>Utilize os filtros abaixo para localizar, visualizar ou exportar processos SEI tramitando pela NOVACAP.</p>
  </header>

  <!-- 🔍 FILTROS DE PESQUISA -->
  <form method="GET" action="{{ url_for('processos_bp.consultar_processos') }}" class="filter-card">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="form-grid">
      <!-- Nº Processo SEI -->
      <div class="form-group">
        <label for="numero_processo"><i class="fas fa-hashtag"></i> Nº Processo SEI</label>
        <input type="text" id="numero_processo" name="numero_processo"
               placeholder="00000-00000000/0000-00"
               value="{{ request.args.get('numero_processo', '') }}">
      </div>

      <!-- Status -->
      <div class="form-group">
        <label for="status"><i class="fas fa-flag"></i> Status</label>
        <select id="status" name="status">
          <option value="">Todos</option>
          {% for s in todos_status %}
            <option value="{{ s.descricao }}" {% if request.args.get('status') == s.descricao %}selected{% endif %}>
              {{ s.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Diretoria -->
      <div class="form-group">
        <label for="diretoria"><i class="fas fa-building"></i> Diretoria de Destino</label>
        <select id="diretoria" name="diretoria">
          <option value="">Todas</option>
          {% for d in diretorias %}
            <option value="{{ d }}" {% if request.args.get('diretoria') == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Região Administrativa -->
      <div class="form-group">
        <label for="ra"><i class="fas fa-map-marker-alt"></i> Região Administrativa</label>
        <select id="ra" name="ra">
          <option value="">Todas</option>
          {% for r in todas_ras %}
            <option value="{{ r.descricao_ra }}" {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>
              {{ r.descricao_ra }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Tipo de Demanda -->
      <div class="form-group">
        <label for="tipo"><i class="fas fa-tag"></i> Tipo de Demanda</label>
        <select id="tipo" name="tipo">
          <option value="">Todos</option>
          {% for t in tipos %}
            <option value="{{ t.id_tipo }}" {% if request.args.get('tipo') == t.id_tipo|string %}selected{% endif %}>
              {{ t.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Demanda -->
      <div class="form-group">
        <label for="demanda"><i class="fas fa-list-ul"></i> Demanda</label>
        <select id="demanda" name="demanda">
          <option value="">Todas</option>
          {% for d in demandas %}
            <option value="{{ d.id_demanda }}" {% if request.args.get('demanda') == d.id_demanda|string %}selected{% endif %}>
              {{ d.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Datas -->
      <div class="form-group">
        <label for="inicio"><i class="fas fa-calendar-plus"></i> Data Início</label>
        <input type="date" id="inicio" name="inicio" value="{{ request.args.get('inicio', '') }}">
      </div>
      <div class="form-group">
        <label for="fim"><i class="fas fa-calendar-alt"></i> Data Fim</label>
        <input type="date" id="fim" name="fim" value="{{ request.args.get('fim', '') }}">
      </div>
    </div>

    <!-- 🔘 Botões de Ação -->
    <div class="button-toolbar">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i> Consultar
      </button>
      <a href="{{ url_for('processos_bp.consultar_processos') }}" class="btn btn-outline-gray">
        <i class="fas fa-eraser"></i> Limpar
      </a>
    </div>
  </form>

  <!-- 📊 RESULTADOS -->
  {% if processos %}
  <div class="card" style="margin-top: 2rem; padding: 1.5rem 2rem; border-radius: 12px; box-shadow: var(--shadow);">

    <!-- Exportações -->
    <div class="export-bar">
      <span>Exportar resultados:</span>
      <div style="display: flex; gap: 0.6rem;">
        <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='csv') }}" class="btn btn-outline-blue btn-sm">
          <i class="fas fa-file-csv"></i> CSV
        </a>
        <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='xlsx') }}" class="btn btn-outline-blue btn-sm">
          <i class="fas fa-file-excel"></i> XLSX
        </a>
        <a href="{{ url_for('processos_bp.exportar_tramitacoes', formato='pdf') }}" class="btn btn-outline-blue btn-sm">
          <i class="fas fa-file-pdf"></i> PDF
        </a>
      </div>
    </div>

    <!-- TABELA DE RESULTADOS -->
    <div class="table-responsive">
      <table class="table-hover">
        <thead>
          <tr>
            <th>Nº Processo</th>
            <th>RA Origem</th>
            <th>Tipo</th>
            <th>Diretoria</th>
            <th>Status Atual</th>
            <th>Última Movimentação</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for p in processos %}
          <tr>
            <td><strong>{{ p.numero_processo }}</strong></td>
            <td>{{ p.entrada.ra_origem if p.entrada else '---' }}</td>
            <td>{{ p.entrada.tipo.descricao if p.entrada and p.entrada.tipo else '---' }}</td>
            <td>{{ p.diretoria_destino or '---' }}</td>
            <td>
              {% if "Atendido" in p.status_atual %}
                <span class="badge success">{{ p.status_atual }}</span>
              {% elif "Devolvido" in p.status_atual %}
                <span class="badge warning">{{ p.status_atual }}</span>
              {% elif "Improcedente" in p.status_atual %}
                <span class="badge danger">{{ p.status_atual }}</span>
              {% else %}
                <span class="badge neutral">{{ p.status_atual or "---" }}</span>
              {% endif %}
            </td>
            <td>{{ p.ultima_data.strftime('%d/%m/%Y') if p.ultima_data else '---' }}</td>
            <td>
              <a href="{{ url_for('processos_bp.exportar_processo_pdf', id_processo=p.id_processo) }}"
                 class="btn btn-outline-blue btn-sm" title="Gerar PDF do processo">
                <i class="fas fa-file-pdf"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    {% if processos_paginados %}
    <div class="pagination">
      <span>Exibindo {{ processos_paginados.start_index() }}–{{ processos_paginados.end_index() }} de {{ processos_paginados.total }}</span>
      <div>
        {% if processos_paginados.has_prev %}
          <a href="{{ url_for('processos_bp.consultar_processos', page=processos_paginados.prev_num) }}" class="btn btn-outline-blue btn-sm">&laquo; Anterior</a>
        {% endif %}
        {% if processos_paginados.has_next %}
          <a href="{{ url_for('processos_bp.consultar_processos', page=processos_paginados.next_num) }}" class="btn btn-outline-blue btn-sm">Próxima &raquo;</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  {% else %}
  <p style="margin-top: 2rem; text-align: center; color: #777;">
    Nenhum processo encontrado com os filtros aplicados.
  </p>
  {% endif %}

  <!-- ⚙ RODAPÉ DE AÇÕES -->
  <div class="button-toolbar" style="margin-top: 2.5rem; justify-content:center;">
    <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn btn-secondary">
      <i class="fas fa-chart-bar"></i> Voltar ao Dashboard
    </a>
    <a href="{{ url_for('main_bp.logout') }}" class="btn btn-danger">
      <i class="fas fa-sign-out-alt"></i> Sair
    </a>
  </div>

</section>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}
