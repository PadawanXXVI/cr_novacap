{% extends "base.html" %}

{% block title %}Painel Administrativo ‚Äì Central de Relacionamento NOVACAP{% endblock %}

{% block content %}

<style>
.painel-admin-full {
    max-width: 1600px !important;
    width: 95% !important;
    margin: 2rem auto;
}
</style>

<section class="container fade-in painel-admin-full">

  <header class="text-center">
    <h1><i class="fas fa-user-cog"></i> Painel Administrativo</h1>
    <p style="color: var(--text-muted); margin-bottom: 1rem;">
      Gerencie cadastros, permiss√µes e bloqueios de usu√°rios no sistema.
    </p>
  </header>

  <!-- Barra de a√ß√µes -->
  <div class="button-group" style="justify-content: flex-end;">
    <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn-secondary">
      <i class="fas fa-chart-bar"></i> Voltar ao Dashboard
    </a>
    <a href="{{ url_for('main_bp.logout') }}" class="btn-danger">
      <i class="fas fa-sign-out-alt"></i> Sair
    </a>
  </div>

  <!-- Busca -->
  <form method="GET" action="{{ url_for('admin_bp.painel_admin') }}" class="filtros card" style="margin-top: 1.5rem; padding: 1rem;">
    <div class="form-row" style="gap: 1rem; flex-wrap: wrap; align-items: center;">
      <input type="text" name="q" placeholder="üîç Buscar por nome, usu√°rio ou e-mail..."
             value="{{ request.args.get('q', '') }}" style="flex: 1; min-width: 300px;">
      <button type="submit" class="btn-primary"><i class="fas fa-search"></i> Pesquisar</button>
      {% if request.args.get('q') %}
      <a href="{{ url_for('admin_bp.painel_admin') }}" class="btn-outline-gray">
        <i class="fas fa-undo"></i> Limpar
      </a>
      {% endif %}
    </div>
  </form>

  <!-- Mensagens -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" style="margin-top: 1rem;">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Tabela -->
  {% if usuarios %}
  <div class="table-responsive" style="margin-top: 2rem;">
    <table class="table-hover">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Usu√°rio</th>
          <th>E-mail</th>
          <th>Aprovado?</th>
          <th>Admin?</th>
          <th>Bloqueado?</th>
          <th style="text-align: center;">A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        {% for u in usuarios %}
        <tr>
          <td>{{ u.nome }}</td>
          <td>{{ u.usuario }}</td>
          <td>{{ u.email }}</td>

          <td>
            {% if u.aprovado %}
              <span style="color: var(--accent); font-weight: 600;"><i class="fas fa-check"></i> Sim</span>
            {% else %}
              <span style="color: var(--danger); font-weight: 600;"><i class="fas fa-times"></i> N√£o</span>
            {% endif %}
          </td>

          <td>
            {% if u.is_admin %}
              <span style="color: var(--primary); font-weight: 600;"><i class="fas fa-user-tie"></i> Sim</span>
            {% else %}
              <span style="color: var(--text-muted);"><i class="fas fa-user"></i> N√£o</span>
            {% endif %}
          </td>

          <td>
            {% if u.bloqueado %}
              <span style="color: var(--danger); font-weight: 600;"><i class="fas fa-lock"></i> Sim</span>
            {% else %}
              <span style="color: var(--accent); font-weight: 600;"><i class="fas fa-unlock"></i> N√£o</span>
            {% endif %}
          </td>

          <td>
            <div class="button-group" style="gap: 0.4rem; flex-wrap: wrap; justify-content: center;">

              {% if not u.aprovado %}
              <form method="POST" action="{{ url_for('admin_bp.aprovar_usuario', id_usuario=u.id_usuario) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn-success"><i class="fas fa-user-check"></i> Aprovar</button>
              </form>
              {% endif %}

              {% if not u.is_admin %}
              <form method="POST" action="{{ url_for('admin_bp.atribuir_admin', id_usuario=u.id_usuario) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn-warning"><i class="fas fa-user-shield"></i> Admin</button>
              </form>
              {% endif %}

              {% if not u.bloqueado %}
              <form method="POST" action="{{ url_for('admin_bp.bloquear_usuario', id_usuario=u.id_usuario) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn-danger"><i class="fas fa-user-slash"></i> Bloquear</button>
              </form>
              {% else %}
              <form method="POST" action="{{ url_for('admin_bp.desbloquear_usuario', id_usuario=u.id_usuario) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn-outline-blue"><i class="fas fa-unlock"></i> Desbloquear</button>
              </form>
              {% endif %}

            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  {% else %}
  <p style="margin-top: 2rem; text-align: center; color: var(--text-muted);">
    Nenhum usu√°rio encontrado.
  </p>
  {% endif %}

</section>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

{% endblock %}
