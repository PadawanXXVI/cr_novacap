{% extends "base.html" %}
{% block title %}Relat√≥rios Avan√ßados ‚Äî CR-NOVACAP{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/relatorios.css') }}">

<section class="page-section fade-in">

  <!-- Cabe√ßalho -->
  <header class="text-center" style="margin-bottom: 2rem;">
    <h1 style="color:#004a8f; font-size:clamp(1.8rem,3vw,2.3rem); font-weight:700;">
      <i class="fas fa-chart-line"></i> Relat√≥rios Avan√ßados
    </h1>
    <p style="color:#555; font-size:1.05rem; max-width:800px; margin:0.6rem auto;">
      Utilize os filtros abaixo para gerar an√°lises detalhadas.
      Os resultados, totais e gr√°ficos refletem exatamente a combina√ß√£o de filtros aplicada.
    </p>
  </header>

  <!-- üîç FILTROS -->
  <form method="GET"
        action="{{ url_for('relatorios_bp.relatorios_avancados') }}"
        class="card-form">

    <div class="intro-filtros">
      Os filtros podem ser usados isoladamente ou em conjunto, sem ordem obrigat√≥ria.
    </div>

    <div class="form-grid">

      <!-- 1. Diretoria -->
      <div class="form-group">
        <label><i class="fas fa-building"></i> Diretoria</label>
        <select name="diretoria">
          <option value="">Todas</option>
          {% for d in todas_diretorias %}
            <option value="{{ d.descricao_exibicao }}"
              {% if request.args.get('diretoria') == d.descricao_exibicao %}selected{% endif %}>
              {{ d.descricao_exibicao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 2. Departamento -->
      <div class="form-group">
        <label><i class="fas fa-sitemap"></i> Departamento</label>
        <select name="departamento">
          <option value="">Todos</option>
          {% for dep in todos_departamentos %}
            <option value="{{ dep.nome }}"
              {% if request.args.get('departamento') == dep.nome %}selected{% endif %}>
              {{ dep.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 3. Demanda / Servi√ßo -->
      <div class="form-group">
        <label><i class="fas fa-wrench"></i> Tipo de Demanda (Servi√ßo)</label>
        <select name="servico">
          <option value="">Todas</option>
          {% for d in todas_demandas %}
            <option value="{{ d.descricao }}"
              {% if request.args.get('servico') == d.descricao %}selected{% endif %}>
              {{ d.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 4. Regi√£o Administrativa -->
      <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> Regi√£o Administrativa</label>
        <select name="ra">
          <option value="">Todas</option>
          {% for r in todas_ras %}
            <option value="{{ r.descricao_ra }}"
              {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>
              {{ r.descricao_ra }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 5. Status Atual -->
      <div class="form-group">
        <label><i class="fas fa-flag"></i> Status Atual</label>
        <select name="status">
          <option value="">Todos</option>
          {% for s in todos_status %}
            <option value="{{ s.descricao }}"
              {% if request.args.get('status') == s.descricao %}selected{% endif %}>
              {{ s.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 6. Data In√≠cio -->
      <div class="form-group">
        <label><i class="fas fa-calendar-plus"></i> Data In√≠cio</label>
        <input type="date" name="inicio" value="{{ request.args.get('inicio', '') }}">
      </div>

      <!-- 7. Data Fim -->
      <div class="form-group">
        <label><i class="fas fa-calendar-alt"></i> Data Fim</label>
        <input type="date" name="fim" value="{{ request.args.get('fim', '') }}">
      </div>

    </div>

    <!-- Bot√µes -->
    <div class="button-toolbar">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-filter"></i> Aplicar Filtros
      </button>

      <a href="{{ url_for('relatorios_bp.relatorios_avancados') }}"
         class="btn btn-outline-gray">
        <i class="fas fa-eraser"></i> Limpar
      </a>
    </div>

  </form>

  <!-- üìä CARDS -->
  <div class="card-grid">

    <div class="info-card">
      <h3>Total de Registros Encontrados</h3>
      <div class="info-value">{{ total_resultados }}</div>
    </div>

    <div class="info-card">
      <h3>Total de RAs Envolvidas</h3>
      <div class="info-value">{{ total_ras }}</div>
    </div>

    <div class="info-card">
      <h3>Demandas Distintas</h3>
      <div class="info-value">{{ total_demandas }}</div>
    </div>

  </div>

  <!-- üìà GR√ÅFICOS -->
  <h2 class="section-title-graficos">
    <i class="fas fa-chart-bar"></i> Gr√°ficos
  </h2>

  <div class="graficos-grid">
    <div id="grafico_status" class="grafico-card"></div>
    <div id="grafico_ra" class="grafico-card"></div>
    <div id="grafico_diretoria" class="grafico-card"></div>
    <div id="grafico_departamento" class="grafico-card"></div>
  </div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script>
    // Dados do relat√≥rio enviados pela rota (DataFrame -> dict -> JSON)
    const dados = JSON.parse {{ session.get('dados_relatorio', []) | tojson | safe }};

    function renderMensagemVazia(id) {
      const el = document.getElementById(id);
      if (el) {
        el.innerHTML = '<p class="grafico-vazio">Nenhum dado para exibir com os filtros selecionados.</p>';
      }
    }

    function gerarGraficoBarra(id, titulo, campo, topN = null) {
      if (!dados || !dados.length) {
        renderMensagemVazia(id);
        return;
      }

      const contagem = {};
      dados.forEach(item => {
        const chave = item[campo] || "N√£o informado";
        contagem[chave] = (contagem[chave] || 0) + 1;
      });

      let pares = Object.keys(contagem).map(k => ({ label: k, valor: contagem[k] }));

      // Ordena do maior para o menor
      pares.sort((a, b) => b.valor - a.valor);

      // Limita ao topN (ex.: top 10 RAs)
      if (topN && pares.length > topN) {
        pares = pares.slice(0, topN);
      }

      const labels = pares.map(p => p.label);
      const valores = pares.map(p => p.valor);

      if (!labels.length) {
        renderMensagemVazia(id);
        return;
      }

      Plotly.newPlot(id, [{
        x: labels,
        y: valores,
        type: 'bar'
      }], {
        title: titulo,
        xaxis: {
          automargin: true,
          tickangle: -30
        },
        yaxis: { title: 'Qtd. Processos' },
        margin: { t: 50, b: 120, l: 60, r: 20 }
      }, {
        responsive: true
      });
    }

    // Status de todos os registros filtrados
    gerarGraficoBarra("grafico_status", "Distribui√ß√£o por Status", "Status");

    // Top 10 RAs (ou menos, se tiver menos de 10)
    gerarGraficoBarra("grafico_ra", "Top RAs por quantidade de processos", "RA", 10);

    // Diretoria ‚Äî ideal quando se filtra s√≥ RA, Status ou per√≠odo
    gerarGraficoBarra("grafico_diretoria", "Distribui√ß√£o por Diretoria", "Diretoria");

    // Departamentos dentro das diretorias
    gerarGraficoBarra("grafico_departamento", "Distribui√ß√£o por Departamento", "Departamento");
  </script>

  <!-- üìÑ TABELA -->
  <h2 class="section-title-tabela">
    <i class="fas fa-table"></i> Tabela de Resultados
  </h2>

  <div class="export-buttons">
    <a href="{{ url_for('relatorios_bp.exportar_relatorios', formato='csv') }}"
       class="btn btn-outline-blue">
      <i class="fas fa-file-csv"></i> CSV
    </a>
    <a href="{{ url_for('relatorios_bp.exportar_relatorios', formato='xlsx') }}"
       class="btn btn-outline-blue">
      <i class="fas fa-file-excel"></i> XLSX
    </a>
  </div>

  <div class="table-area">
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>N¬∫ Processo</th>
          <th>RA</th>
          <th>Status</th>
          <th>Diretoria</th>
          <th>Departamento</th>
          <th>Servi√ßo</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
        </tr>
      </thead>

      <tbody>
        {% for mov, user, entrada, processo, demanda, departamento, diretoria in resultados %}
        <tr>
          <td>{{ mov.data.strftime("%d/%m/%Y %H:%M") }}</td>
          <td>{{ processo.numero_processo }}</td>
          <td>{{ entrada.ra_origem }}</td>
          <td>{{ mov.novo_status }}</td>
          <td>{{ diretoria.descricao_exibicao }}</td>
          <td>{{ departamento.nome }}</td>
          <td>{{ demanda.descricao }}</td>
          <td>{{ user.usuario }}</td>
          <td>{{ mov.observacao }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</section>

{% endblock %}
