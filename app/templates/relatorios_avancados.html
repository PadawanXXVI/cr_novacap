{% extends "base.html" %}
{% block title %}Relat√≥rios Avan√ßados ‚Äî CR-NOVACAP{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/relatorios.css') }}">

<section class="page-section fade-in">

  <!-- Cabe√ßalho -->
  <header class="text-center" style="margin-bottom: 2rem;">
    <h1 style="color:#004a8f; font-size:clamp(1.8rem,3vw,2.3rem); font-weight:700;">
      <i class="fas fa-chart-line"></i> Relat√≥rios Avan√ßados
    </h1>
    <p style="color:#555; font-size:1.05rem; max-width:800px; margin:0.6rem auto;">
      Utilize os filtros abaixo para gerar an√°lises detalhadas.  
      Tabelas e gr√°ficos refletem exatamente os filtros selecionados.
    </p>
  </header>

  <!-- üîç FILTROS -->
  <form method="GET" action="{{ url_for('relatorios_bp.relatorios_avancados') }}" class="card-form">

    <div class="form-grid">

      <!-- RA -->
      <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> Regi√£o Administrativa</label>
        <select name="ra">
          <option value="">Todas</option>
          {% for r in todas_ras %}
            <option value="{{ r.descricao_ra }}"
              {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>
              {{ r.descricao_ra }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Demanda -->
      <div class="form-group">
        <label><i class="fas fa-wrench"></i> Tipo de Demanda (Servi√ßo)</label>
        <select name="servico">
          <option value="">Todas</option>
          {% for d in todas_demandas %}
            <option value="{{ d.descricao }}"
              {% if request.args.get('servico') == d.descricao %}selected{% endif %}>
              {{ d.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Status -->
      <div class="form-group">
        <label><i class="fas fa-flag"></i> Status Atual</label>
        <select name="status">
          <option value="">Todos</option>
          {% for s in todos_status %}
            <option value="{{ s.descricao }}"
              {% if request.args.get('status') == s.descricao %}selected{% endif %}>
              {{ s.descricao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Diretoria -->
      <div class="form-group">
        <label><i class="fas fa-building"></i> Diretoria</label>
        <select name="diretoria">
          <option value="">Todas</option>
          {% for d in todas_diretorias %}
            <option value="{{ d.descricao_exibicao }}"
              {% if request.args.get('diretoria') == d.descricao_exibicao %}selected{% endif %}>
              {{ d.descricao_exibicao }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Departamento -->
      <div class="form-group">
        <label><i class="fas fa-sitemap"></i> Departamento</label>
        <select name="departamento">
          <option value="">Todos</option>
          {% for dep in todos_departamentos %}
            <option value="{{ dep.nome }}"
              {% if request.args.get('departamento') == dep.nome %}selected{% endif %}>
              {{ dep.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Data In√≠cio -->
      <div class="form-group">
        <label><i class="fas fa-calendar-plus"></i> Data In√≠cio</label>
        <input type="date" name="inicio" value="{{ request.args.get('inicio', '') }}">
      </div>

      <!-- Data Fim -->
      <div class="form-group">
        <label><i class="fas fa-calendar-alt"></i> Data Fim</label>
        <input type="date" name="fim" value="{{ request.args.get('fim', '') }}">
      </div>

    </div>

    <!-- Bot√µes -->
    <div class="button-toolbar">
      <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Aplicar Filtros</button>
      <a href="{{ url_for('relatorios_bp.relatorios_avancados') }}" class="btn btn-outline-gray">
        <i class="fas fa-eraser"></i> Limpar
      </a>
    </div>

  </form>

  <!-- üìä CARDS -->
  <div class="card-grid">

    <div class="info-card">
      <h3>Total de Registros Encontrados</h3>
      <div class="info-value">{{ total_resultados }}</div>
    </div>

    <div class="info-card">
      <h3>Total de RAs Envolvidas</h3>
      <div class="info-value">{{ total_ras }}</div>
    </div>

    <div class="info-card">
      <h3>Demandas Distintas</h3>
      <div class="info-value">{{ total_demandas }}</div>
    </div>

  </div>

  <!-- üìà GR√ÅFICOS -->
  <h2 style="color:#003c7a; margin-top:2rem;">Gr√°ficos</h2>

  <div id="grafico_status"></div>
  <div id="grafico_ra"></div>
  <div id="grafico_diretoria"></div>
  <div id="grafico_departamento"></div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script>
    const dados = JSON.parse('{{ session.get("dados_relatorio", []) | tojson | safe }}');

    function gerarGrafico(id, titulo, campo) {
      if (!dados || dados.length === 0) return;

      const contagem = {};
      dados.forEach(item => {
        const chave = item[campo] || "N√£o informado";
        contagem[chave] = (contagem[chave] || 0) + 1;
      });

      Plotly.newPlot(id, [{
        x: Object.keys(contagem),
        y: Object.values(contagem),
        type: 'bar'
      }], {
        title: titulo,
        xaxis: { automargin: true },
        margin: { t: 40, b: 120 }
      });
    }

    gerarGrafico("grafico_status", "Distribui√ß√£o por Status", "Status");
    gerarGrafico("grafico_ra", "Distribui√ß√£o por RA", "RA");
    gerarGrafico("grafico_diretoria", "Distribui√ß√£o por Diretoria", "Diretoria");
    gerarGrafico("grafico_departamento", "Distribui√ß√£o por Departamento", "Departamento");
  </script>

  <!-- üìÑ TABELA -->
  <h2 style="color:#003c7a; margin-top:2rem;">Tabela de Resultados</h2>

  <div class="export-buttons">
    <a href="{{ url_for('relatorios_bp.exportar_relatorios', formato='csv') }}" class="btn btn-outline-blue">
      <i class="fas fa-file-csv"></i> CSV
    </a>
    <a href="{{ url_for('relatorios_bp.exportar_relatorios', formato='xlsx') }}" class="btn btn-outline-blue">
      <i class="fas fa-file-excel"></i> XLSX
    </a>
  </div>

  <div class="table-area">
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>N¬∫ Processo</th>
          <th>RA</th>
          <th>Status</th>
          <th>Diretoria</th>
          <th>Departamento</th>
          <th>Servi√ßo</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
        </tr>
      </thead>

      <tbody>
        {% for mov, user, entrada, processo, demanda, departamento, diretoria in resultados %}
        <tr>
          <td>{{ mov.data.strftime("%d/%m/%Y %H:%M") }}</td>
          <td>{{ processo.numero_processo }}</td>
          <td>{{ entrada.ra_origem }}</td>
          <td>{{ mov.novo_status }}</td>
          <td>{{ diretoria.descricao_exibicao }}</td>
          <td>{{ departamento.nome }}</td>
          <td>{{ demanda.descricao }}</td>
          <td>{{ user.usuario }}</td>
          <td>{{ mov.observacao }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</section>

{% endblock %}
