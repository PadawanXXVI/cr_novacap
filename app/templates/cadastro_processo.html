{% extends "base.html" %}

{% block title %}Cadastro de Processo - CR/NOVACAP{% endblock %}

{% block content %}
<section class="cadastro-processo-section">
    <h1>Cadastro de Processo</h1>
    <p class="text-center" style="color: var(--text-muted); margin-bottom: 1rem;">
        Preencha corretamente os campos abaixo para registrar um novo processo no sistema.
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('processos_bp.cadastro_processo') }}">
        <!-- üîí Token CSRF obrigat√≥rio -->
        {{ csrf_token() }}

        <!-- N√∫mero do Processo -->
        <div class="form-group">
            <label for="numero_processo">N√∫mero do Processo</label>
            <input type="text" id="numero_processo" name="numero_processo" placeholder="00000-00000000/0000-00" required>
        </div>

        <!-- Datas e RA -->
        <div class="form-row">
            <div class="form-col">
                <label for="data_criacao_ra">Data de Cria√ß√£o na RA</label>
                <input type="date" id="data_criacao_ra" name="data_criacao_ra" required>
            </div>
            <div class="form-col">
                <label for="ra_origem">Regi√£o Administrativa</label>
                <select id="ra_origem" name="ra_origem" required>
                    <option value="">Selecione</option>
                    {% for r in regioes %}
                        <option value="{{ r.descricao_ra }}">{{ r.descricao_ra }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Entrada e Tramite -->
        <div class="form-row">
            <div class="form-col">
                <label for="data_entrada_novacap">Data de Entrada na NOVACAP</label>
                <input type="date" id="data_entrada_novacap" name="data_entrada_novacap" required>
            </div>
            <div class="form-col">
                <label for="tramite_inicial">Tramita√ß√£o Inicial</label>
                <select id="tramite_inicial" name="tramite_inicial" required>
                    <option value="">Selecione</option>
                    <option value="SECRE">SECRE</option>
                    <option value="CR">CR</option>
                </select>
            </div>
        </div>

        <!-- Demandas -->
        <div class="form-row">
            <div class="form-col">
                <label for="id_demanda">Demanda</label>
                <select id="id_demanda" name="id_demanda" required>
                    <option value="">Selecione</option>
                    {% for demanda in demandas %}
                        <option value="{{ demanda.id_demanda }}">{{ demanda.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-col">
                <label for="id_tipo">Tipo de Demanda</label>
                <select id="id_tipo" name="id_tipo" required>
                    <option value="">Selecione</option>
                    {% for tipo in tipos %}
                        <option value="{{ tipo.id_tipo }}">{{ tipo.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Documento e Respons√°vel -->
        <div class="form-row">
            <div class="form-col">
                <label for="data_documento">Data do Documento</label>
                <input type="date" id="data_documento" name="data_documento" required>
            </div>
            <div class="form-col">
                <label for="usuario_responsavel">Respons√°vel T√©cnico</label>
                <select id="usuario_responsavel" name="usuario_responsavel" required>
                    <option value="">Selecione</option>
                    {% for u in usuarios %}
                        <option value="{{ u.id_usuario }}">{{ u.nome }} ({{ u.usuario }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Status e Diretoria -->
        <div class="form-row">
            <div class="form-col">
                <label for="status_inicial">Status Inicial</label>
                <select id="status_inicial" name="status_inicial" required>
                    <option value="">Selecione</option>
                    {% for s in status %}
                        <option value="{{ s.descricao }}">{{ s.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-col">
                <label for="diretoria_destino">Diretoria de Destino</label>
                <select id="diretoria_destino" name="diretoria_destino" required>
                    <option value="">Selecione</option>
                    {% for d in diretorias %}
                        <option value="{{ d }}">{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Observa√ß√µes -->
        <div class="form-group">
            <label for="observacoes">Observa√ß√µes</label>
            <textarea id="observacoes" name="observacoes" rows="3" placeholder="Observa√ß√µes relevantes (opcional)..."></textarea>
        </div>

        <!-- Bot√µes -->
        <div class="button-group">
            <button type="submit" class="btn-primary">Salvar Processo</button>

            <a href="{{ url_for('processos_bp.dashboard_processos') }}">
                <button type="button" class="btn-secondary">Tela de Totais</button>
            </a>

            <a href="{{ url_for('processos_bp.buscar_processo') }}">
                <button type="button" class="btn-outline-gray">Visualizar Processo</button>
            </a>

            <a href="{{ url_for('main_bp.logout') }}">
                <button type="button" class="btn-danger">Sair do Sistema</button>
            </a>
        </div>
    </form>
</section>

<!-- ===== Verifica√ß√£o AJAX com CSRF ===== -->
<script>
document.getElementById('numero_processo').addEventListener('blur', function () {
    const numero = this.value.trim();
    if (numero.length < 10) return;

    fetch('{{ url_for("processos_bp.verificar_processo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // Inclui o token CSRF no cabe√ßalho da requisi√ß√£o
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ numero_processo: numero })
    })
    .then(response => response.json())
    .then(data => {
        if (data.existe) {
            if (confirm("‚ö†Ô∏è Este n√∫mero de processo j√° existe. Deseja alter√°-lo?")) {
                window.location.href = "/processos/alterar/" + data.id;
            } else {
                document.getElementById('numero_processo').value = "";
                alert("Informe um novo n√∫mero de processo.");
            }
        }
    })
    .catch(error => console.error('Erro na verifica√ß√£o do processo:', error));
});
</script>
{% endblock %}
