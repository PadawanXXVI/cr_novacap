{% extends "base.html" %}

{% block title %}Cadastro de Processo – Central de Relacionamento NOVACAP{% endblock %}

{% block content %}
<section class="container fade-in cadastro-processo-section">
  <header class="text-center">
    <h1><i class="fas fa-folder-plus"></i> Cadastro de Processo</h1>
    <p style="color: var(--text-muted); margin-bottom: 1rem;">
      Preencha corretamente os campos abaixo para registrar um novo processo no sistema.
    </p>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('processos_bp.cadastro_processo') }}" class="card" style="padding: 2rem; border-radius: 12px;">
    {{ csrf_token() }}

    <!-- Número do Processo -->
    <div class="form-group">
      <label for="numero_processo"><i class="fas fa-hashtag"></i> Número do Processo</label>
      <input type="text" id="numero_processo" name="numero_processo" placeholder="00000-00000000/0000-00" required>
    </div>

    <!-- Datas e RA -->
    <div class="form-row">
      <div class="form-col">
        <label for="data_criacao_ra"><i class="fas fa-calendar-plus"></i> Data de Criação na RA</label>
        <input type="date" id="data_criacao_ra" name="data_criacao_ra" required>
      </div>
      <div class="form-col">
        <label for="ra_origem"><i class="fas fa-map-marker-alt"></i> Região Administrativa</label>
        <select id="ra_origem" name="ra_origem" required>
          <option value="">Selecione</option>
          {% for r in regioes %}
            <option value="{{ r.descricao_ra }}">{{ r.descricao_ra }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Entrada e Tramitação -->
    <div class="form-row">
      <div class="form-col">
        <label for="data_entrada_novacap"><i class="fas fa-sign-in-alt"></i> Data de Entrada na NOVACAP</label>
        <input type="date" id="data_entrada_novacap" name="data_entrada_novacap" required>
      </div>
      <div class="form-col">
        <label for="tramite_inicial"><i class="fas fa-random"></i> Tramitação Inicial</label>
        <select id="tramite_inicial" name="tramite_inicial" required>
          <option value="">Selecione</option>
          <option value="SECRE">SECRE</option>
          <option value="CR">CR</option>
        </select>
      </div>
    </div>

    <!-- Demandas -->
    <div class="form-row">
      <div class="form-col">
        <label for="id_demanda"><i class="fas fa-list-ul"></i> Demanda</label>
        <select id="id_demanda" name="id_demanda" required>
          <option value="">Selecione</option>
          {% for demanda in demandas %}
            <option value="{{ demanda.id_demanda }}">{{ demanda.descricao }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-col">
        <label for="id_tipo"><i class="fas fa-tag"></i> Tipo de Demanda</label>
        <select id="id_tipo" name="id_tipo" required>
          <option value="">Selecione</option>
          {% for tipo in tipos %}
            <option value="{{ tipo.id_tipo }}">{{ tipo.descricao }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Documento e Responsável -->
    <div class="form-row">
      <div class="form-col">
        <label for="data_documento"><i class="fas fa-file-alt"></i> Data do Documento</label>
        <input type="date" id="data_documento" name="data_documento" required>
      </div>
      <div class="form-col">
        <label for="usuario_responsavel"><i class="fas fa-user-tie"></i> Responsável Técnico</label>
        <select id="usuario_responsavel" name="usuario_responsavel" required>
          <option value="">Selecione</option>
          {% for u in usuarios %}
            <option value="{{ u.id_usuario }}">{{ u.nome }} ({{ u.usuario }})</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Status e Diretoria -->
    <div class="form-row">
      <div class="form-col">
        <label for="status_inicial"><i class="fas fa-flag"></i> Status Inicial</label>
        <select id="status_inicial" name="status_inicial" required>
          <option value="">Selecione</option>
          {% for s in status %}
            <option value="{{ s.descricao }}">{{ s.descricao }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-col">
        <label for="diretoria_destino"><i class="fas fa-building"></i> Diretoria de Destino</label>
        <select id="diretoria_destino" name="diretoria_destino" required>
          <option value="">Selecione</option>
          {% for d in diretorias %}
            <option value="{{ d }}">{{ d }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Observações -->
    <div class="form-group">
      <label for="observacoes"><i class="fas fa-comment-dots"></i> Observações</label>
      <textarea id="observacoes" name="observacoes" rows="3" placeholder="Observações relevantes (opcional)..."></textarea>
    </div>

    <!-- Botões -->
    <div class="button-group" style="margin-top: 2rem;">
      <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Processo</button>
      <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn-secondary"><i class="fas fa-chart-bar"></i> Tela de Totais</a>
      <a href="{{ url_for('processos_bp.buscar_processo') }}" class="btn-outline-gray"><i class="fas fa-eye"></i> Visualizar Processo</a>
      <a href="{{ url_for('main_bp.logout') }}" class="btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</a>
    </div>
  </form>
</section>

<!-- Verificação AJAX de número de processo -->
<script>
document.getElementById('numero_processo').addEventListener('blur', function () {
  const numero = this.value.trim();
  if (numero.length < 10) return;

  fetch('{{ url_for("processos_bp.verificar_processo") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify({ numero_processo: numero })
  })
  .then(response => response.json())
  .then(data => {
    if (data.existe) {
      if (confirm("⚠️ Este número de processo já existe. Deseja alterá-lo?")) {
        window.location.href = "/processos/alterar/" + data.id;
      } else {
        document.getElementById('numero_processo').value = "";
        alert("Informe um novo número de processo.");
      }
    }
  })
  .catch(error => console.error('Erro na verificação do processo:', error));
});
</script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}
