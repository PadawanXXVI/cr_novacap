{% extends "base.html" %}

{% block title %}Lista de Processos ‚Äì Central de Relacionamento NOVACAP{% endblock %}

{% block content %}
<section class="container fade-in listar-processos-section">
  <header class="text-center">
    <h1><i class="fas fa-folder-tree"></i> Lista de Processos</h1>
    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
      Consulte, filtre e exporte os processos registrados no sistema.
    </p>
  </header>

  <!-- üîç FILTROS DE PESQUISA -->
  <form method="GET" action="{{ url_for('processos_bp.listar_processos') }}" class="filtros card" style="padding: 1.5rem; border-radius: 10px;">
    <div class="form-row" style="gap: 1rem; flex-wrap: wrap;">
      <select name="status" class="filter-select">
        <option value="">üü¢ Filtrar por status</option>
        {% for s in todos_status %}
          <option value="{{ s.descricao }}" {% if request.args.get('status') == s.descricao %}selected{% endif %}>
            {{ s.descricao }}
          </option>
        {% endfor %}
      </select>

      <select name="ra" class="filter-select">
        <option value="">üèôÔ∏è Filtrar por RA</option>
        {% for r in todas_ras %}
          <option value="{{ r.descricao_ra }}" {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>
            {{ r.descricao_ra }}
          </option>
        {% endfor %}
      </select>

      <select name="diretoria" class="filter-select">
        <option value="">üè¢ Filtrar por Diretoria</option>
        {% for d in diretorias %}
          <option value="{{ d }}" {% if request.args.get('diretoria') == d %}selected{% endif %}>
            {{ d }}
          </option>
        {% endfor %}
      </select>

      <input type="date" name="inicio" value="{{ request.args.get('inicio', '') }}" title="Data inicial">
      <input type="date" name="fim" value="{{ request.args.get('fim', '') }}" title="Data final">

      <button type="submit" class="btn-primary"><i class="fas fa-filter"></i> Filtrar</button>
      <a href="{{ url_for('processos_bp.listar_processos') }}" class="btn-outline-gray">
        <i class="fas fa-undo"></i> Limpar
      </a>
    </div>
  </form>

  <!-- üì§ EXPORTA√á√ïES -->
  {% if processos %}
  <form method="GET" style="margin-top: 1rem;">
    {{ csrf_token() }}
    <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
    <input type="hidden" name="ra" value="{{ request.args.get('ra', '') }}">
    <input type="hidden" name="diretoria" value="{{ request.args.get('diretoria', '') }}">
    <input type="hidden" name="inicio" value="{{ request.args.get('inicio', '') }}">
    <input type="hidden" name="fim" value="{{ request.args.get('fim', '') }}">

    <div class="button-group" style="justify-content: flex-end;">
      <button type="submit" formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}" name="formato" value="csv" class="btn-outline-blue">
        <i class="fas fa-file-csv"></i> CSV
      </button>
      <button type="submit" formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}" name="formato" value="xlsx" class="btn-outline-blue">
        <i class="fas fa-file-excel"></i> XLSX
      </button>
      <button type="submit" formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}" name="formato" value="pdf" class="btn-outline-blue">
        <i class="fas fa-file-pdf"></i> PDF
      </button>
    </div>
  </form>
  {% endif %}

  <!-- üìã TABELA DE PROCESSOS -->
  {% if processos %}
  <div class="table-responsive" style="margin-top: 1.5rem;">
    <table class="table-hover">
      <thead>
        <tr>
          <th><i class="fas fa-hashtag"></i> N√∫mero</th>
          <th><i class="fas fa-info-circle"></i> Status Atual</th>
          <th><i class="fas fa-map-marker-alt"></i> RA Origem</th>
          <th><i class="fas fa-layer-group"></i> Tipo</th>
          <th><i class="fas fa-building"></i> Diretoria</th>
          <th><i class="fas fa-calendar-alt"></i> √öltima Movimenta√ß√£o</th>
          <th><i class="fas fa-cog"></i> A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for p in processos %}
        <tr>
          <td>{{ p.numero_processo }}</td>
          <td>{{ p.status_atual or '---' }}</td>
          <td>{{ p.entrada.ra_origem if p.entrada else '---' }}</td>
          <td>{{ p.entrada.tipo.descricao if p.entrada and p.entrada.tipo else '---' }}</td>
          <td>{{ p.diretoria_destino or '---' }}</td>
          <td>{{ p.ultima_data.strftime('%d/%m/%Y %H:%M') if p.ultima_data else '---' }}</td>
          <td>
            <div class="button-group" style="gap: 0.4rem; justify-content:center;">
              <a href="{{ url_for('processos_bp.buscar_processo') }}?numero_processo={{ p.numero_processo }}" class="btn-secondary">
                <i class="fas fa-eye"></i> Visualizar
              </a>
              <a href="{{ url_for('processos_bp.alterar_processo', id_processo=p.id_processo) }}" class="btn-primary">
                <i class="fas fa-edit"></i> Alterar
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="margin-top: 2rem; text-align: center; color: var(--text-muted);">
    Nenhum processo encontrado com os crit√©rios informados.
  </p>
  {% endif %}

  <!-- ‚öôÔ∏è RODAP√â DE A√á√ïES -->
  <div class="button-group" style="margin-top: 2.5rem;">
    <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn-secondary">
      <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
    </a>

    {% if session.get('is_admin') %}
    <a href="{{ url_for('relatorios_bp.relatorios_dc') }}" class="btn-outline-blue">
      <i class="fas fa-chart-line"></i> Relat√≥rios Avan√ßados
    </a>
    {% endif %}

    <a href="{{ url_for('main_bp.logout') }}" class="btn-danger">
      <i class="fas fa-sign-out-alt"></i> Sair
    </a>
  </div>
</section>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}
