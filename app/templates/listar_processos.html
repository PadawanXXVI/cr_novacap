{% extends "base.html" %}

{% block title %}Lista de Processos - CR/NOVACAP{% endblock %}

{% block content %}
<section class="listar-processos-section container">
    <h1>Lista de Processos</h1>
    <p class="text-center" style="color: var(--text-muted); margin-bottom: 1rem;">
        Consulte, filtre e exporte os processos registrados no sistema.
    </p>

    <!-- ===================================================== -->
    <!-- üîç FILTROS DE PESQUISA -->
    <!-- ===================================================== -->
    <form method="GET" action="{{ url_for('processos_bp.listar_processos') }}" class="filtros">
        <select name="status">
            <option value="">-- Filtrar por status --</option>
            {% for s in todos_status %}
                <option value="{{ s.descricao }}" {% if request.args.get('status') == s.descricao %}selected{% endif %}>
                    {{ s.descricao }}
                </option>
            {% endfor %}
        </select>

        <select name="ra">
            <option value="">-- Filtrar por RA --</option>
            {% for r in todas_ras %}
                <option value="{{ r.descricao_ra }}" {% if request.args.get('ra') == r.descricao_ra %}selected{% endif %}>
                    {{ r.descricao_ra }}
                </option>
            {% endfor %}
        </select>

        <select name="diretoria">
            <option value="">-- Filtrar por Diretoria --</option>
            {% for d in diretorias %}
                <option value="{{ d }}" {% if request.args.get('diretoria') == d %}selected{% endif %}>
                    {{ d }}
                </option>
            {% endfor %}
        </select>

        <input type="date" name="inicio" value="{{ request.args.get('inicio', '') }}">
        <input type="date" name="fim" value="{{ request.args.get('fim', '') }}">

        <button type="submit" class="btn-primary">Filtrar</button>
        <a href="{{ url_for('processos_bp.listar_processos') }}" class="btn-outline">Limpar</a>
    </form>

    <!-- ===================================================== -->
    <!-- üì§ EXPORTA√á√ïES -->
    <!-- ===================================================== -->
    {% if processos %}
    <form method="GET" class="exportar" style="margin-top: 1rem;">
        {{ csrf_token() }}
        <!-- Mant√©m filtros ativos -->
        <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
        <input type="hidden" name="ra" value="{{ request.args.get('ra', '') }}">
        <input type="hidden" name="diretoria" value="{{ request.args.get('diretoria', '') }}">
        <input type="hidden" name="inicio" value="{{ request.args.get('inicio', '') }}">
        <input type="hidden" name="fim" value="{{ request.args.get('fim', '') }}">

        <div class="button-group" style="justify-content: flex-end;">
            <button type="submit"
                    formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}"
                    name="formato" value="csv"
                    class="btn-outline">Exportar CSV</button>

            <button type="submit"
                    formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}"
                    name="formato" value="xlsx"
                    class="btn-outline">Exportar XLSX</button>

            <button type="submit"
                    formaction="{{ url_for('processos_bp.exportar_tramitacoes') }}"
                    name="formato" value="pdf"
                    class="btn-outline">Exportar PDF</button>
        </div>
    </form>
    {% endif %}

    <!-- ===================================================== -->
    <!-- üìã TABELA DE PROCESSOS -->
    <!-- ===================================================== -->
    {% if processos %}
    <div class="table-responsive" style="margin-top: 1.5rem;">
        <table>
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Status Atual</th>
                    <th>RA Origem</th>
                    <th>Tipo</th>
                    <th>Diretoria</th>
                    <th>√öltima Movimenta√ß√£o</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for p in processos %}
                <tr>
                    <td>{{ p.numero_processo }}</td>
                    <td>{{ p.status_atual or '---' }}</td>
                    <td>{{ p.entrada.ra_origem if p.entrada else '---' }}</td>
                    <td>{{ p.entrada.tipo.descricao if p.entrada and p.entrada.tipo else '---' }}</td>
                    <td>{{ p.diretoria_destino or '---' }}</td>
                    <td>{{ p.ultima_data.strftime('%d/%m/%Y %H:%M') if p.ultima_data else '---' }}</td>
                    <td>
                        <div class="button-group" style="gap: 0.4rem;">
                            <a href="{{ url_for('processos_bp.buscar_processo') }}?numero_processo={{ p.numero_processo }}" class="btn-secondary">Visualizar</a>
                            <a href="{{ url_for('processos_bp.alterar_processo', id_processo=p.id_processo) }}" class="btn-primary">Alterar</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="margin-top: 2rem; text-align: center;">Nenhum processo encontrado com os crit√©rios informados.</p>
    {% endif %}

    <!-- ===================================================== -->
    <!-- ‚öôÔ∏è RODAP√â DE A√á√ïES -->
    <!-- ===================================================== -->
    <div class="button-group" style="margin-top: 2rem;">
        <a href="{{ url_for('processos_bp.dashboard_processos') }}" class="btn-secondary">Voltar ao Dashboard</a>

        {% if session.get('is_admin') %}
        <a href="{{ url_for('relatorios_bp.relatorios_dc') }}" class="btn-outline">Relat√≥rios Avan√ßados</a>
        {% endif %}

        <a href="{{ url_for('main_bp.logout') }}" class="btn-danger">Sair</a>
    </div>
</section>
{% endblock %}
