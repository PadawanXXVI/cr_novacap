{% extends "base.html" %}

{% block title %}Painel Administrativo - CR/NOVACAP{% endblock %}

{% block content %}
<section class="container painel-admin-section">

  <!-- Cabe√ßalho -->
  <h1>Painel Administrativo</h1>
  <p class="text-center" style="color: var(--text-muted); margin-bottom: 1rem;">
    Gerencie cadastros, permiss√µes e bloqueios de usu√°rios no sistema.
  </p>

  <!-- Barra de a√ß√µes -->
  <div class="button-group" style="justify-content: flex-end;">
    <a href="{{ url_for('processos_bp.dashboard_processos') }}">
      <button class="btn-secondary">Voltar ao Dashboard</button>
    </a>
    <a href="{{ url_for('main_bp.logout') }}">
      <button class="btn-danger">Sair</button>
    </a>
  </div>

  <!-- Busca -->
  <form method="GET" action="{{ url_for('admin_bp.painel_admin') }}" class="filtros" style="margin-top: 1rem;">
    <input type="text" name="q" placeholder="üîé Buscar por nome, usu√°rio ou e-mail..." 
           value="{{ request.args.get('q', '') }}" style="flex: 1; min-width: 300px;">
    <button type="submit" class="btn-primary">Pesquisar</button>
    {% if request.args.get('q') %}
      <a href="{{ url_for('admin_bp.painel_admin') }}">
        <button type="button" class="btn-outline-gray">Limpar</button>
      </a>
    {% endif %}
  </form>

  <!-- Mensagens do sistema -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" style="margin-top: 1rem;">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Tabela de Usu√°rios -->
  {% if usuarios %}
    <div class="table-responsive" style="margin-top: 2rem;">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Usu√°rio</th>
            <th>E-mail</th>
            <th>Aprovado?</th>
            <th>Admin?</th>
            <th>Bloqueado?</th>
            <th style="text-align: center;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
            <tr>
              <td>{{ u.nome }}</td>
              <td>{{ u.usuario }}</td>
              <td>{{ u.email }}</td>

              <!-- Aprovado -->
              <td>
                {% if u.aprovado %}
                  <span style="color: var(--accent); font-weight: 600;">Sim</span>
                {% else %}
                  <span style="color: var(--danger); font-weight: 600;">N√£o</span>
                {% endif %}
              </td>

              <!-- Admin -->
              <td>
                {% if u.is_admin %}
                  <span style="color: var(--primary); font-weight: 600;">Sim</span>
                {% else %}
                  <span style="color: var(--text-muted);">N√£o</span>
                {% endif %}
              </td>

              <!-- Bloqueado -->
              <td>
                {% if u.bloqueado %}
                  <span style="color: var(--danger); font-weight: 600;">Sim</span>
                {% else %}
                  <span style="color: var(--accent); font-weight: 600;">N√£o</span>
                {% endif %}
              </td>

              <!-- A√ß√µes -->
              <td>
                <div class="button-group" style="gap: 0.4rem; flex-wrap: wrap; justify-content: center;">

                  {% if not u.aprovado %}
                    <form method="POST" action="{{ url_for('admin_bp.aprovar_usuario', id_usuario=u.id_usuario) }}">
                      <button type="submit" class="btn-success" title="Aprovar usu√°rio">Aprovar</button>
                    </form>
                  {% endif %}

                  {% if not u.is_admin %}
                    <form method="POST" action="{{ url_for('admin_bp.atribuir_admin', id_usuario=u.id_usuario) }}">
                      <button type="submit" class="btn-warning" title="Conceder permiss√£o de administrador">Admin</button>
                    </form>
                  {% endif %}

                  {% if not u.bloqueado %}
                    <form method="POST" action="{{ url_for('admin_bp.bloquear_usuario', id_usuario=u.id_usuario) }}">
                      <button type="submit" class="btn-danger" title="Bloquear usu√°rio">Bloquear</button>
                    </form>
                  {% else %}
                    <form method="POST" action="{{ url_for('admin_bp.desbloquear_usuario', id_usuario=u.id_usuario) }}">
                      <button type="submit" class="btn-outline-blue" title="Desbloquear usu√°rio">Desbloquear</button>
                    </form>
                  {% endif %}

                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p style="margin-top: 2rem; text-align: center;">
      Nenhum usu√°rio encontrado ou pendente de aprova√ß√£o.
    </p>
  {% endif %}

</section>
{% endblock %}
