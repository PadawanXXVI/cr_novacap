{% extends "base.html" %}

{% block title %}Visualizar Processo - CR/NOVACAP{% endblock %}

{% block content %}
<section class="container visualizar-processo-section">
  <h1>Visualizar Processo</h1>
  <p class="text-center" style="color: var(--text-muted); margin-bottom: 1rem;">
    Consulte as informa√ß√µes detalhadas de um processo SEI.
  </p>

  <!-- ===================================================== -->
  <!-- üîç FORMUL√ÅRIO DE BUSCA -->
  <!-- ===================================================== -->
  <form method="GET" action="{{ url_for('processos_bp.buscar_processo') }}" class="text-center" style="margin-bottom: 2rem;">
    <label for="numero_processo"><strong>N√∫mero do Processo:</strong></label>
    <input type="text" name="numero_processo" id="numero_processo"
           placeholder="00000-00000000/0000-00" required />
    <button type="submit" class="btn-primary">Buscar</button>
  </form>

  <!-- ===================================================== -->
  <!-- ‚ö†Ô∏è MENSAGENS DE SISTEMA -->
  <!-- ===================================================== -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if processo %}
  <!-- ===================================================== -->
  <!-- üìÑ INFORMA√á√ïES DO PROCESSO -->
  <!-- ===================================================== -->
  <div class="card">
    <h3>Informa√ß√µes do Processo</h3>
    <p><strong>N√∫mero:</strong> {{ processo.numero_processo or '---' }}</p>
    <p><strong>Status Atual:</strong> {{ processo.status_atual or '---' }}</p>
    <p><strong>Diretoria de Destino:</strong> {{ processo.diretoria_destino or '---' }}</p>
    <p><strong>Observa√ß√µes:</strong> {{ processo.observacoes or '---' }}</p>

    <div class="button-group" style="margin-top: 1rem;">
      <a href="{{ url_for('processos_bp.exportar_processo_pdf', id_processo=processo.id_processo) }}">
        <button class="btn-outline">Exportar em PDF</button>
      </a>
    </div>
  </div>

  {% if entrada %}
  <!-- ===================================================== -->
  <!-- üì• DADOS DE ENTRADA -->
  <!-- ===================================================== -->
  <div class="card">
    <h3>Informa√ß√µes da Entrada</h3>
    <p><strong>RA de Origem:</strong> {{ entrada.ra_origem or '---' }}</p>
    <p><strong>Tramita√ß√£o Inicial:</strong> {{ entrada.tramite_inicial or '---' }}</p>
    <p><strong>Data de Entrada na NOVACAP:</strong>
      {{ entrada.data_entrada_novacap.strftime('%d/%m/%Y') if entrada.data_entrada_novacap else '---' }}</p>
    <p><strong>Data do Documento:</strong>
      {{ entrada.data_documento.strftime('%d/%m/%Y') if entrada.data_documento else '---' }}</p>
    <p><strong>Tipo:</strong> {{ entrada.tipo.descricao if entrada.tipo else '---' }}</p>
    <p><strong>Respons√°vel T√©cnico:</strong>
      {% if entrada.responsavel %}
        {{ entrada.responsavel.nome }} ({{ entrada.responsavel.usuario }})
      {% else %}
        ---
      {% endif %}
    </p>
  </div>
  {% endif %}

  <!-- ===================================================== -->
  <!-- üîÅ HIST√ìRICO DE MOVIMENTA√á√ïES -->
  <!-- ===================================================== -->
  <div class="card">
    <h3>Hist√≥rico de Movimenta√ß√µes</h3>
    {% if movimentacoes %}
      <p><strong>Total de Tramita√ß√µes:</strong> {{ movimentacoes|length }}</p>
      <ul style="list-style: none; padding-left: 0;">
        {% for mov in movimentacoes %}
          <li style="margin-bottom: 0.75rem;">
            <strong>{{ mov.data.strftime('%d/%m/%Y %H:%M') if mov.data else '---' }}</strong> ‚Äî 
            Status: <strong>{{ mov.novo_status or '---' }}</strong> ‚Äî 
            Por: <strong>{{ mov.usuario.usuario if mov.usuario else '---' }}</strong><br>
            <em>{{ mov.observacao or '' }}</em>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Sem movimenta√ß√µes registradas.</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- ===================================================== -->
  <!-- ‚èé BOT√ÉO DE RETORNO -->
  <!-- ===================================================== -->
  <div class="button-group" style="margin-top: 2rem;">
    <a href="{{ url_for('processos_bp.dashboard_processos') }}">
      <button class="btn-secondary">Voltar ao Dashboard</button>
    </a>
  </div>
</section>
{% endblock %}
